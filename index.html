<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mental Maths Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .operation-checkbox:checked + label,
        .challenge-radio:checked + label,
        .difficulty-radio:checked + label {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        .feedback-correct { animation: flash-green 0.5s ease-out; }
        .feedback-incorrect { animation: flash-red 0.5s ease-out; }
        @keyframes flash-green { 0% { background-color: #dcfce7; } 100% { background-color: transparent; } }
        @keyframes flash-red { 0% { background-color: #fee2e2; } 100% { background-color: transparent; } }
        #history-modal { backdrop-filter: blur(5px); }
        .disabled-op {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f3f4f6;
            border-color: #d1d5db;
        }
        .disabled-op label:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-2xl mx-auto p-4 sm:p-6 md:p-8 bg-white rounded-2xl shadow-2xl transition-all duration-500">
        
        <!-- Setup Screen -->
        <div id="setup-screen">
            <h1 class="text-3xl sm:text-4xl font-bold text-center text-indigo-600 mb-2">Mental Maths Challenge</h1>
            <p class="text-center text-gray-500 mb-6">Configure your challenge or review your history.</p>

            <div class="bg-gray-50 p-4 rounded-lg mb-6 text-center">
                <label for="score-file-upload" class="block text-sm font-medium text-gray-700 mb-2">Load Score History from Computer</label>
                <input type="file" id="score-file-upload" accept=".csv" class="text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 w-full">
                <p class="text-xs text-gray-500 mt-2">To save to Google Drive, download the CSV and upload it manually.</p>
                <p id="upload-status" class="text-xs text-green-600 mt-1 h-4"></p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label for="grade-select" class="block text-sm font-medium text-gray-700 mb-2">Grade Level</label>
                    <select id="grade-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <option value="0" selected>KG</option><option value="1">Grade 1</option><option value="2">Grade 2</option>
                        <option value="3">Grade 3</option><option value="4">Grade 4</option><option value="5">Grade 5</option>
                        <option value="6">Grade 6</option><option value="7">Grade 7</option><option value="8">Grade 8</option>
                        <option value="9">Grade 9</option><option value="10">Grade 10</option><option value="11">Grade 11</option>
                        <option value="12">Grade 12</option>
                    </select>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Challenge Type</label>
                    <div class="grid grid-cols-2 gap-3">
                        <div><input type="radio" id="type-timed" name="challengeType" value="timed" class="hidden challenge-radio" checked><label for="type-timed" class="block w-full text-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-indigo-50 transition">2 Min Test</label></div>
                        <div><input type="radio" id="type-questions" name="challengeType" value="questions" class="hidden challenge-radio"><label for="type-questions" class="block w-full text-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-indigo-50 transition">20 Questions</label></div>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Difficulty</label>
                <div class="grid grid-cols-3 gap-3">
                    <div><input type="radio" id="diff-easy" name="difficulty" value="easy" class="hidden difficulty-radio" checked><label for="diff-easy" class="block w-full text-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-indigo-50 transition">Easy</label></div>
                    <div><input type="radio" id="diff-intermediate" name="difficulty" value="intermediate" class="hidden difficulty-radio"><label for="diff-intermediate" class="block w-full text-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-indigo-50 transition">Intermediate</label></div>
                    <div><input type="radio" id="diff-hard" name="difficulty" value="hard" class="hidden difficulty-radio"><label for="diff-hard" class="block w-full text-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-indigo-50 transition">Hard</label></div>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">Operations</label>
                <div id="operations-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                    <div id="op-container-add"><input type="checkbox" id="op-add" value="addition" class="hidden operation-checkbox"><label for="op-add" class="block w-full text-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-indigo-50 transition">Addition</label></div>
                    <div id="op-container-subtract"><input type="checkbox" id="op-subtract" value="subtraction" class="hidden operation-checkbox"><label for="op-subtract" class="block w-full text-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-indigo-50 transition">Subtraction</label></div>
                    <div id="op-container-multiply"><input type="checkbox" id="op-multiply" value="multiplication" class="hidden operation-checkbox"><label for="op-multiply" class="block w-full text-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-indigo-50 transition">Multiply</label></div>
                    <div id="op-container-divide"><input type="checkbox" id="op-divide" value="division" class="hidden operation-checkbox"><label for="op-divide" class="block w-full text-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-indigo-50 transition">Division</label></div>
                    <div id="op-container-percentage"><input type="checkbox" id="op-percentage" value="percentage" class="hidden operation-checkbox"><label for="op-percentage" class="block w-full text-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-indigo-50 transition">Percentage</label></div>
                    <div id="op-container-square"><input type="checkbox" id="op-square" value="square" class="hidden operation-checkbox"><label for="op-square" class="block w-full text-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-indigo-50 transition">Square/Root</label></div>
                    <div id="op-container-cube"><input type="checkbox" id="op-cube" value="cube" class="hidden operation-checkbox"><label for="op-cube" class="block w-full text-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-indigo-50 transition">Cube/Root</label></div>
                    <div id="op-container-mix"><input type="checkbox" id="op-mix" value="mix" class="hidden operation-checkbox"><label for="op-mix" class="block w-full text-center p-3 border-2 border-dashed border-gray-400 rounded-lg cursor-pointer hover:bg-indigo-50 transition">Mix All</label></div>
                </div>
            </div>

            <button id="start-btn" class="w-full mt-8 bg-indigo-600 text-white font-bold py-4 rounded-lg shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition-transform transform hover:scale-105">Start Challenge</button>
            <button id="view-history-btn" class="w-full mt-3 bg-gray-600 text-white font-bold py-3 rounded-lg hover:bg-gray-700 transition">View History</button>
            <p id="setup-error" class="text-red-500 text-center mt-4 h-5"></p>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden">
            <div class="grid grid-cols-3 items-center mb-6 text-lg text-center">
                <div>Score: <span id="score" class="font-bold text-indigo-600">0</span></div>
                <div id="challenge-status" class="font-bold text-indigo-600"></div>
                <div>High Score: <span id="high-score" class="font-bold text-indigo-600">N/A</span></div>
            </div>
            <div id="question-area" class="text-center p-6 rounded-lg mb-6"><p id="question-text" class="text-4xl sm:text-5xl md:text-6xl font-mono tracking-wider"></p></div>
            <form id="answer-form">
                <input type="text" id="answer-input" inputmode="numeric" pattern="[0-9.-]*" class="w-full text-center text-2xl p-4 border-2 border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Your answer...">
                <button type="submit" class="w-full mt-4 bg-indigo-600 text-white font-bold py-4 rounded-lg shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition-transform transform hover:scale-105">Submit</button>
            </form>
            <p id="feedback" class="text-center mt-4 h-6 text-lg font-medium"></p>
        </div>

        <!-- Summary Screen -->
        <div id="summary-screen" class="hidden text-center">
            <h2 id="summary-title" class="text-3xl font-bold text-indigo-600 mb-4">Challenge Complete!</h2>
            <div id="celebration" class="hidden my-4">
                <img src="https://media.giphy.com/media/YTbZzCkRQCEJa/giphy.gif" alt="Well Done! Celebration confetti" class="mx-auto rounded-lg">
            </div>
            <p class="text-xl mb-2">Final Score: <span id="final-score" class="font-bold"></span></p>
            <div id="summary-details" class="text-left bg-gray-50 p-4 rounded-lg my-6"></div>
            
            <!-- Question Review Section -->
            <div id="review-container" class="my-6">
                <h3 class="text-xl font-bold text-gray-800 mb-3">Question Review</h3>
                <div id="review-details" class="text-left bg-gray-50 p-4 rounded-lg max-h-60 overflow-y-auto">
                    <ul id="review-list" class="space-y-3">
                        <!-- Review items will be injected here -->
                    </ul>
                </div>
            </div>

            <div class="flex justify-center gap-4">
                <button id="save-btn" class="w-1/2 bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">Save & Exit</button>
                <button id="play-again-btn" class="w-1/2 bg-gray-600 text-white font-bold py-3 rounded-lg hover:bg-gray-700 transition">Play Again</button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center"><h2 class="text-2xl font-bold text-indigo-600">Score History</h2><button id="close-history-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button></div>
            <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4 border-b">
                <div class="grid grid-cols-2 gap-2">
                    <input type="date" id="filter-date-start" class="p-2 border rounded-lg" title="Start Date">
                    <input type="date" id="filter-date-end" class="p-2 border rounded-lg" title="End Date">
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <select id="filter-grade" class="p-2 border rounded-lg"><option value="">All Grades</option></select>
                    <select id="filter-difficulty" class="p-2 border rounded-lg"><option value="">All Difficulties</option></select>
                    <select id="filter-operation" class="p-2 border rounded-lg"><option value="">All Operations</option></select>
                </div>
            </div>
            <div class="p-4 overflow-auto">
                <table class="w-full text-sm text-left"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-4 py-3">Date</th><th class="px-4 py-3">Grade</th><th class="px-4 py-3">Difficulty</th><th class="px-4 py-3">Type</th><th class="px-4 py-3">Operations</th><th class="px-4 py-3">Score</th></tr></thead><tbody id="history-table-body"></tbody></table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const el = {
                setupScreen: document.getElementById('setup-screen'), gameScreen: document.getElementById('game-screen'),
                summaryScreen: document.getElementById('summary-screen'), historyModal: document.getElementById('history-modal'),
                startBtn: document.getElementById('start-btn'), gradeSelect: document.getElementById('grade-select'),
                operationsGrid: document.getElementById('operations-grid'), mixCheckbox: document.getElementById('op-mix'),
                setupError: document.getElementById('setup-error'), scoreEl: document.getElementById('score'),
                challengeStatusEl: document.getElementById('challenge-status'), highScoreEl: document.getElementById('high-score'),
                questionArea: document.getElementById('question-area'), questionTextEl: document.getElementById('question-text'),
                answerForm: document.getElementById('answer-form'), answerInput: document.getElementById('answer-input'),
                feedbackEl: document.getElementById('feedback'), summaryTitleEl: document.getElementById('summary-title'),
                finalScoreEl: document.getElementById('final-score'), summaryDetailsEl: document.getElementById('summary-details'),
                saveBtn: document.getElementById('save-btn'), playAgainBtn: document.getElementById('play-again-btn'),
                scoreFileUpload: document.getElementById('score-file-upload'), uploadStatus: document.getElementById('upload-status'),
                viewHistoryBtn: document.getElementById('view-history-btn'), closeHistoryBtn: document.getElementById('close-history-btn'),
                historyTableBody: document.getElementById('history-table-body'), filterDateStart: document.getElementById('filter-date-start'),
                filterDateEnd: document.getElementById('filter-date-end'), filterGrade: document.getElementById('filter-grade'),
                filterDifficulty: document.getElementById('filter-difficulty'), filterOperation: document.getElementById('filter-operation'),
                celebration: document.getElementById('celebration'),
                reviewList: document.getElementById('review-list'),
            };

            // Game State & Constants
            let currentQuestion = {}, score = 0, selectedOps = [], grade = 0, difficulty = 'easy';
            let scoresByOp = {}, challengeType = 'timed', timerInterval, timeLeft = 120, questionsAnswered = 0;
            const TOTAL_QUESTIONS = 20;
            let scoreHistory = [];
            let sessionHistory = []; // To store questions from the current session
            let currentHighScore = null;
            
            // --- Difficulty Settings ---
            const DIFFICULTY_SETTINGS = {
                 0: { easy: { r: [1, 5], m: [1, 2] }, intermediate: { r: [1, 10], m: [1, 3] }, hard: { r: [1, 15], m: [1, 5] } },
                 1: { easy: { r: [1, 10], m: [1, 3] }, intermediate: { r: [1, 20], m: [1, 5] }, hard: { r: [-5, 25], m: [2, 5] } },
                 2: { easy: { r: [10, 30], m: [1, 5] }, intermediate: { r: [10, 50], m: [1, 10] }, hard: { r: [-10, 75], m: [2, 12] } },
                 3: { easy: { r: [10, 50], m: [2, 10] }, intermediate: { r: [10, 100], m: [2, 12] }, hard: { r: [-20, 150], m: [3, 15] } },
                 4: { easy: { r: [20, 100], m: [2, 12], p: 100, s: [2, 5], c: [2, 4] }, intermediate: { r: [20, 150], m: [3, 15], p: 150, s: [3, 8], c: [2, 5] }, hard: { r: [-20, 200], m: [5, 15], p: 200, s: [5, 12], c: [3, 6] } },
                 5: { easy: { r: [20, 200], m: [5, 15], p: 200, s: [2, 10], c: [2, 5] }, intermediate: { r: [10, 250], m: [5, 20], p: 300, s: [5, 15], c: [3, 7] }, hard: { r: [-50, 300], m: [8, 20], p: 400, s: [10, 20], c: [4, 8] } },
                 6: { easy: { r: [1, 25], m: [1, 10], p: 100, s: [2, 10], c: [2, 5] }, intermediate: { r: [10, 100], m: [2, 12], p: 200, s: [5, 15], c: [3, 7] }, hard: { r: [-20, 150], m: [5, 15], p: 500, s: [10, 20], c: [5, 10] } },
                 7: { easy: { r: [10, 50], m: [2, 12], p: 200, s: [2, 15], c: [2, 7] }, intermediate: { r: [-10, 150], m: [5, 15], p: 500, s: [10, 20], c: [4, 8] }, hard: { r: [-50, 250], m: [8, 20], p: 1000, s: [15, 25], c: [6, 12] } },
                 8: { easy: { r: [20, 100], m: [5, 15], p: 400, s: [5, 20], c: [3, 10] }, intermediate: { r: [-50, 250], m: [10, 20], p: 800, s: [15, 25], c: [5, 12] }, hard: { r: [-100, 500], m: [11, 25], p: 1500, s: [20, 30], c: [7, 15] } },
                 9: { easy: { r: [50, 200], m: [10, 20], p: 500, s: [10, 25], c: [5, 12] }, intermediate: { r: [-100, 500], m: [11, 25], p: 1000, s: [15, 30], c: [6, 15] }, hard: { r: [-250, 750], m: [15, 30], p: 2000, s: [25, 40], c: [8, 18] } },
                10: { easy: { r: [100, 500], m: [10, 30], p: 800, s: [15, 30], c: [6, 15] }, intermediate: { r: [-200, 800], m: [15, 35], p: 1500, s: [20, 40], c: [8, 18] }, hard: { r: [-500, 1200], m: [20, 40], p: 2500, s: [30, 50], c: [10, 20] } },
                11: { easy: { r: [-100, 500], m: [-15, 30], p: 1000, s: [20, 50], c: [10, 20] }, intermediate: { r: [-500, 1500], m: [-20, 40], p: 2000, s: [30, 60], c: [12, 22] }, hard: { r: [-1000, 2500], m: [-25, 50], p: 5000, s: [40, 70], c: [15, 25] } },
                12: { easy: { r: [-200, 1000], m: [-20, 50], p: 1200, s: [30, 100], c: [15, 25] }, intermediate: { r: [-1000, 2000], m: [-25, 50], p: 3000, s: [40, 80], c: [18, 28] }, hard: { r: [-1500, 3000], m: [-30, 60], p: 6000, s: [50, 100], c: [20, 30] } }
            };

            // --- Event Listeners ---
            el.mixCheckbox.addEventListener('change', handleMixCheck);
            el.startBtn.addEventListener('click', startGame);
            el.answerForm.addEventListener('submit', checkAnswer);
            el.saveBtn.addEventListener('click', () => { saveScores(); resetToSetup(); });
            el.playAgainBtn.addEventListener('click', resetToSetup);
            el.scoreFileUpload.addEventListener('change', handleFileUpload);
            el.viewHistoryBtn.addEventListener('click', showHistoryModal);
            el.closeHistoryBtn.addEventListener('click', () => {el.historyModal.classList.add('hidden'); el.historyModal.classList.remove('flex');});
            [el.filterDateStart, el.filterDateEnd, el.filterGrade, el.filterDifficulty, el.filterOperation].forEach(f => f.addEventListener('change', applyFilters));
            el.gradeSelect.addEventListener('change', updateOperationAvailability);

            // --- Initial Setup ---
            updateOperationAvailability();

            function checkAnswer(e) {
                e.preventDefault();
                const userAnswerRaw = el.answerInput.value;
                const userAnswer = parseFloat(userAnswerRaw);
                if (userAnswerRaw.trim() === '' || isNaN(userAnswer)) return;

                const isCorrect = userAnswer === currentQuestion.answer;
                
                sessionHistory.push({
                    questionText: currentQuestion.text,
                    userAnswer: userAnswerRaw,
                    correctAnswer: currentQuestion.answer,
                    isCorrect: isCorrect
                });

                questionsAnswered++;
                if(currentQuestion.operation) scoresByOp[currentQuestion.operation].total++;
                el.questionArea.classList.remove('feedback-correct', 'feedback-incorrect');
                void el.questionArea.offsetWidth; // Trigger reflow to restart animation

                if (isCorrect) {
                    score += 2;
                    if(currentQuestion.operation) scoresByOp[currentQuestion.operation].correct++;
                    el.feedbackEl.textContent = "Correct! +2 points";
                    el.feedbackEl.className = "text-center mt-4 h-6 text-lg font-medium text-green-600";
                    el.questionArea.classList.add('feedback-correct');
                } else {
                    score -= 1;
                    el.feedbackEl.textContent = `Incorrect. The answer was ${currentQuestion.answer}. -1 point`;
                    el.feedbackEl.className = "text-center mt-4 h-6 text-lg font-medium text-red-600";
                    el.questionArea.classList.add('feedback-incorrect');
                }
                
                el.scoreEl.textContent = score;

                if (challengeType === 'questions') {
                    updateQuestionCount();
                    if (questionsAnswered >= TOTAL_QUESTIONS) {
                        setTimeout(() => endGame("Challenge Complete!"), 1500);
                        return;
                    }
                }

                setTimeout(() => {
                    el.feedbackEl.textContent = "";
                    if (challengeType !== 'questions' || questionsAnswered < TOTAL_QUESTIONS) {
                        nextQuestion();
                    }
                }, 1500);
            }

            function startGame() {
                // ... (reset logic)
                sessionHistory = []; // Clear session history at the start of a new game
                grade = parseInt(el.gradeSelect.value);
                challengeType = document.querySelector('input[name="challengeType"]:checked').value;
                difficulty = document.querySelector('input[name="difficulty"]:checked').value;
                const checkedBoxes = el.operationsGrid.querySelectorAll('input.operation-checkbox:checked:not(:disabled)');
                selectedOps = Array.from(checkedBoxes).map(cb => cb.value).filter(op => op !== 'mix');
                
                if (selectedOps.length === 0) {
                    el.setupError.textContent = 'Please select at least one operation.';
                    return;
                }
                
                el.setupError.textContent = '';
                scoresByOp = {};
                selectedOps.forEach(op => scoresByOp[op] = { correct: 0, total: 0 });
                score = 0;
                questionsAnswered = 0;
                el.scoreEl.textContent = 0;
                
                el.setupScreen.classList.add('hidden');
                el.summaryScreen.classList.add('hidden');
                el.gameScreen.classList.remove('hidden');
                
                findAndDisplayHighScore();
                if (challengeType === 'timed') {
                    startTimer();
                } else {
                    updateQuestionCount();
                }
                nextQuestion();
            }

            function endGame(title) {
                clearInterval(timerInterval);
                el.celebration.classList.add('hidden');

                if (currentHighScore === null || score > currentHighScore) {
                    el.summaryTitleEl.textContent = "New High Score!";
                    el.celebration.classList.remove('hidden');
                } else {
                    el.summaryTitleEl.textContent = title;
                }
                
                el.finalScoreEl.textContent = score;
                
                // Populate summary details
                let detailsHtml = '<ul class="space-y-2">';
                for (const op in scoresByOp) {
                    const { correct, total } = scoresByOp[op];
                    if (total > 0) {
                        const percentage = total > 0 ? ((correct / total) * 100).toFixed(0) : 0;
                        detailsHtml += `<li class="flex justify-between"><span>${op.charAt(0).toUpperCase() + op.slice(1)}:</span> <strong>${correct}/${total} (${percentage}%)</strong></li>`;
                    }
                }
                detailsHtml += '</ul>';
                el.summaryDetailsEl.innerHTML = detailsHtml;

                // Populate question review
                renderReviewDetails();

                el.gameScreen.classList.add('hidden');
                el.summaryScreen.classList.remove('hidden');
            }

            function renderReviewDetails() {
                el.reviewList.innerHTML = ''; // Clear previous review
                if (sessionHistory.length === 0) {
                    el.reviewList.innerHTML = '<li>No questions were attempted.</li>';
                    return;
                }

                sessionHistory.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'border-b pb-2';
                    if (item.isCorrect) {
                        li.innerHTML = `
                            <p class="font-mono">${item.questionText.replace('?', `<span class="font-bold text-green-600">${item.userAnswer}</span>`)}</p>
                        `;
                    } else {
                        li.innerHTML = `
                            <p class="font-mono">${item.questionText.replace('?', `<span class="font-bold text-red-500 line-through">${item.userAnswer}</span> <span class="font-bold text-green-600">${item.correctAnswer}</span>`)}</p>
                        `;
                    }
                    el.reviewList.appendChild(li);
                });
            }

            // --- Utility and Unchanged Functions ---
            function parseCSV(csvText) { scoreHistory = []; const lines = csvText.trim().split('\n'); if (lines.length < 2) return; const headers = lines[0].split(',').map(h => h.trim()); for (let i = 1; i < lines.length; i++) { const values = lines[i].split(',').map(v => v.trim()); if (values.length === headers.length) { let entry = {}; headers.forEach((header, index) => entry[header] = values[index]); scoreHistory.push(entry); } } if (scoreHistory.length > 0) { scoreHistory.sort((a, b) => { const dateComparison = b.Date.localeCompare(a.Date); if (dateComparison !== 0) return dateComparison; return b.Time.localeCompare(a.Time); }); const lastEntry = scoreHistory[0]; if (lastEntry && lastEntry.Grade) { el.gradeSelect.value = lastEntry.Grade; updateOperationAvailability(); } } }
            function findAndDisplayHighScore() { const opsString = selectedOps.sort().join('+'); const matchingScores = scoreHistory.filter(e => e.Grade == grade && e.Difficulty == difficulty && e.Operations == opsString).map(e => parseInt(e.FinalScore)); const highestScore = matchingScores.length > 0 ? Math.max(...matchingScores) : null; el.highScoreEl.textContent = highestScore !== null ? highestScore : 'N/A'; currentHighScore = highestScore; }
            function resetToSetup() { el.celebration.classList.add('hidden'); el.summaryScreen.classList.add('hidden'); el.setupScreen.classList.remove('hidden'); el.mixCheckbox.checked = false; updateOperationAvailability(); }
            const getNum = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
            const getFloat = (min, max, decimals) => parseFloat((Math.random() * (max - min) + min).toFixed(decimals));
            function updateOperationAvailability() {const currentGrade = parseInt(el.gradeSelect.value); const availableOps = {'add': true, 'subtract': true, 'multiply': currentGrade >= 2, 'divide': currentGrade >= 2, 'percentage': currentGrade >= 4, 'square': currentGrade >= 4, 'cube': currentGrade >= 4,}; for (const [op, isEnabled] of Object.entries(availableOps)) { const checkbox = document.getElementById(`op-${op}`); const container = document.getElementById(`op-container-${op}`); checkbox.disabled = !isEnabled; if (isEnabled) { container.classList.remove('disabled-op'); } else { checkbox.checked = false; container.classList.add('disabled-op');}} handleMixCheck();}
            function handleMixCheck() { const isChecked = el.mixCheckbox.checked; el.operationsGrid.querySelectorAll('input.operation-checkbox').forEach(cb => { if (cb.id !== 'op-mix' && !cb.disabled) { cb.checked = isChecked; } }); }
            function handleFileUpload(event) {const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => {parseCSV(e.target.result); el.uploadStatus.textContent = `${scoreHistory.length} records loaded successfully!`; setTimeout(() => el.uploadStatus.textContent = '', 3000);}; reader.readAsText(file);}
            function showHistoryModal() {if (scoreHistory.length === 0) {el.setupError.textContent = 'Upload a score file to view history.'; setTimeout(() => el.setupError.textContent = '', 3000); return;} populateFilters(); applyFilters(); el.historyModal.classList.remove('hidden'); el.historyModal.classList.add('flex');}
            function populateFilters() {const grades = [...new Set(scoreHistory.map(item => item.Grade))].sort((a,b) => parseInt(a)-parseInt(b)); const difficulties = [...new Set(scoreHistory.map(item => item.Difficulty))]; const operations = [...new Set(scoreHistory.flatMap(item => item.Operations.split('+')))].sort(); el.filterGrade.innerHTML = '<option value="">All Grades</option>' + grades.map(g => `<option value="${g}">${g == '0' ? 'KG' : `Grade ${g}`}</option>`).join(''); el.filterDifficulty.innerHTML = '<option value="">All Difficulties</option>' + difficulties.map(d => `<option value="${d}">${d.charAt(0).toUpperCase() + d.slice(1)}</option>`).join(''); el.filterOperation.innerHTML = '<option value="">All Operations</option>' + operations.map(o => `<option value="${o}">${o.charAt(0).toUpperCase() + o.slice(1)}</option>`).join('');}
            function applyFilters() { let filtered = [...scoreHistory]; const startDate = el.filterDateStart.value; const endDate = el.filterDateEnd.value; if (startDate) filtered = filtered.filter(item => item.Date >= startDate); if (endDate) filtered = filtered.filter(item => item.Date <= endDate); if (el.filterGrade.value) filtered = filtered.filter(item => item.Grade === el.filterGrade.value); if (el.filterDifficulty.value) filtered = filtered.filter(item => item.Difficulty === el.filterDifficulty.value); if (el.filterOperation.value) filtered = filtered.filter(item => item.Operations.includes(el.filterOperation.value)); renderHistoryTable(filtered); }
            function renderHistoryTable(data) {el.historyTableBody.innerHTML = data.map(row => `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-4 py-2">${row.Date}</td><td class="px-4 py-2">${row.Grade == '0' ? 'KG' : `G${row.Grade}`}</td><td class="px-4 py-2">${row.Difficulty}</td><td class="px-4 py-2">${row['Challenge Type']}</td><td class="px-4 py-2">${row.Operations.replace(/\+/g, ', ')}</td><td class="px-4 py-2 font-bold">${row.FinalScore}</td></tr>`).join(''); if (data.length === 0) el.historyTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4">No records match your filters.</td></tr>`;}
            function saveScores() {if (Object.keys(scoresByOp).length === 0 || questionsAnswered === 0) return; const date = new Date(); const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`; const timeString = `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`; const opsString = selectedOps.sort().join('+'); const newRecord = { "Date": dateString, "Time": timeString, "Grade": grade, "Difficulty": difficulty, "Challenge Type": challengeType, "Operations": opsString, "FinalScore": score }; scoreHistory.push(newRecord); const headers = Object.keys(newRecord); let csvContent = headers.join(',') + '\n'; csvContent += scoreHistory.map(row => headers.map(header => row[header]).join(',')).join('\n'); const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "mental_maths_scores.csv"; document.body.appendChild(a); a.click(); document.body.removeChild(a);}
            function nextQuestion() {currentQuestion = generateQuestion(); el.questionTextEl.textContent = currentQuestion.text; el.answerInput.value = ''; el.answerInput.focus();}
            function startTimer() {timeLeft = 120; updateTimerDisplay(); timerInterval = setInterval(() => {timeLeft--; updateTimerDisplay(); if (timeLeft <= 0) { clearInterval(timerInterval); endGame("Time's Up!"); }}, 1000);}
            function updateTimerDisplay() {const minutes = Math.floor(timeLeft / 60); const seconds = timeLeft % 60; el.challengeStatusEl.textContent = `Time: ${minutes}:${String(seconds).padStart(2, '0')}`;}
            function updateQuestionCount() {el.challengeStatusEl.textContent = `Q: ${Math.min(questionsAnswered + 1, TOTAL_QUESTIONS)}/${TOTAL_QUESTIONS}`;}
            function generateQuestion() { const operation = selectedOps[getNum(0, selectedOps.length - 1)]; let q = { operation }; let num1, num2, base; const d = DIFFICULTY_SETTINGS[grade][difficulty]; const askForMissing = Math.random() < 0.3 && grade > 1; switch (operation) { case 'addition': num1 = getNum(d.r[0], d.r[1]); num2 = getNum(d.r[0], d.r[1]); q.answer = num1 + num2; q.text = askForMissing ? `${num1} + ? = ${q.answer}` : `${num1} + ${num2} = ?`; if (askForMissing) q.answer = num2; break; case 'subtraction': num1 = getNum(d.r[0], d.r[1]); num2 = getNum(d.r[0], d.r[1]); if (num1 < num2) [num1, num2] = [num2, num1]; q.answer = num1 - num2; q.text = askForMissing ? `${num1} - ? = ${q.answer}` : `${num1} - ${num2} = ?`; if (askForMissing) q.answer = num2; break; case 'multiplication': num1 = getNum(d.m[0], d.m[1]); num2 = getNum(d.m[0], d.m[1]); q.answer = num1 * num2; q.text = askForMissing ? `${num1} × ? = ${q.answer}` : `${num1} × ${num2} = ?`; if (askForMissing) q.answer = num2; break; case 'division': num2 = getNum(d.m[0], d.m[1]); if (num2 === 0) num2 = 1; let product = num2 * getNum(d.m[0], d.m[1]); q.answer = product / num2; q.text = askForMissing ? `${product} ÷ ? = ${q.answer}` : `${product} ÷ ${num2} = ?`; if (askForMissing) q.answer = num2; break; case 'percentage': let perc; if (difficulty === 'hard') perc = getFloat(0.1, 150, 1); else if (difficulty === 'intermediate') perc = [2.5, 5, 15, 25, 75][getNum(0, 4)]; else perc = [10, 20, 25, 50][getNum(0, 3)]; base = getNum(d.p / 10, d.p); q.answer = parseFloat(((perc / 100) * base).toFixed(2)); q.text = `${perc}% of ${base} = ?`; break; case 'square': base = getNum(d.s[0], d.s[1]); if (Math.random() < 0.5) { q.answer = base; q.text = `√${base * base} = ?`; } else { q.answer = base * base; q.text = `${base}² = ?`; } break; case 'cube': base = getNum(d.c[0], d.c[1]); if (Math.random() < 0.5) { q.answer = base; q.text = `∛${base * base * base} = ?`; } else { q.answer = base * base * base; q.text = `${base}³ = ?`; } break; } return q; }
        });
    </script>
</body>
</html>

